# Generating the Service Contract

These are the instructions for auto-generating the service/data contracts for AgGateway service communication.

## Table of Contents

* [Prerequisites](#prerequisites)
  * [Chocolatey](#chocolatey)
    * [Chocolatey Installation](#chocolatey-installation)
  * [scriptcs](#scriptcs)
    * [scriptcs Installation](#scriptcs-installation)
* [Code Generation](#code-generation)
  * [`svcutil [...]`](#-svcutil----)
  * [`xsd [...]`](#-xsd----)
  * [`Fix2dArray.csx`](#-fix2darraycsx-)
  * [`FixOutboundData.csx`](#-fixoutbounddatacsx-)
  * [`FixXmlQualifiedName.csx`](#-fixxmlqualifiednamecsx-)
  * [`RemoveEmptyNamespaces.csx`](#-removeemptynamespacescsx-)
* [Directory Structure](#directory-structure)
  * [Resources](#resources)
    * [Scripts](#scripts)
    * [Unmodified](#unmodified)

## Prerequisites

### [Chocolatey](https://chocolatey.org/)

Package manager for Windows. [Official Installation Instructions](https://chocolatey.org/install)

This is required for [scriptcs](http://scriptcs.net/) installation.

#### Chocolatey Installation

1. Open PowerShell in Administrator Mode

   * Ensure [Get-ExecutionPolicy](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-6) is not Restricted.

     Run `Get-ExecutionPolicy`. If it returns `Restricted`, then run `Set-ExecutionPolicy AllSigned` or `Set-ExecutionPolicy Bypass -Scope Process`.

1. Run `Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))`

   * **NOTE:** This *will* be executing an external PowerShell script

### [scriptcs](http://scriptcs.net/)

Script runner for C-Sharp Script (`.csx`) files

#### scriptcs Installation

1. Open your favorite terminal and run the following:

   `cinst scriptcs`

   **NOTE:** You may need to restart your terminal.

## Code Generation

Execute the `generate-service-contracts.bat` file from the directory in which it is contained. It contains two commands. It takes care of everything needed automagically. Below is further explanation of what this batch file is doing.

### `svcutil [...]`

This generates the service contracts/data contracts based on `.wsdl` files in the appropriate folder with the proper filename and proper .NET namespace.

[MSDN Documentation](https://docs.microsoft.com/en-us/dotnet/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe)

### `xsd [...]`

This generates data contracts based on `.xsd` files in the appropriate folder with the proper filename and proper .NET namespace.

[MSDN Documentation](https://docs.microsoft.com/en-us/dotnet/standard/serialization/xml-schema-definition-tool-xsd-exe)

### `Fix2dArray.csx`

The `xsd` command has a long-known and well-documented bug where it doesn't know how to properly generate code when it encounters a 2-d array. This fixes that.

### `FixOutboundData.csx`

The AgGateway Doc Exchange `.wsdl` file has an improperly defined name in it. In lieu of modifying the supplied file, I'm fixing it on the back end.

### `FixXmlQualifiedName.csx`

I'll be honest... I couldn't figure out how to properly deal with this, so I'm replacing any instance of those with a string... it *technically* works.

### `RemoveEmptyNamespaces.csx`

This removes the many namespace declarations that define an empty string as the namespace on request/response properties.

* This is a byproduct (from what I can gather) of generating service/data contracts via `svcutil` from `.wsdl` files generated by Java web services.

## Directory Structure

All generated data/service contracts are contained at the root.

### Resources

This contains the supplied spec files (`.wsdl`, `.xsd`), as well as the `generate-service-contracts.bat` used to generate the contracts.

#### Scripts

This contains all of the `.csx` files called by the `generate-service-contracts.bat` file. These scripts manipulate the generated code to actually play nice.

#### Unmodified

This contains unmodifed versions of the supplied spec files within a `.zip` file. Please do not modify these files and place them back in the `.zip` file.
